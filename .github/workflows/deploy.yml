name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate and Clean Secrets
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          echo "=== Secrets ê²€ì¦ ==="
          
          # ê³µë°±/ì¤„ë°”ê¿ˆ ì œê±°
          export CLEAN_HOST=$(echo "$EC2_HOST" | tr -d '[:space:]')
          export CLEAN_USER=$(echo "$EC2_USER" | tr -d '[:space:]')
          
          echo "ì›ë³¸ HOST ê¸¸ì´: ${#EC2_HOST}"
          echo "ì •ë¦¬ í›„ HOST ê¸¸ì´: ${#CLEAN_HOST}"
          echo "HOST ì²« 10ê¸€ì: ${CLEAN_HOST:0:10}"
          
          # ê²€ì¦
          if [ -z "$CLEAN_HOST" ]; then
            echo "âŒ EC2_HOSTê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          # IP ì£¼ì†Œ í˜•ì‹ ê²€ì¦ (ê°„ë‹¨)
          if [[ ! "$CLEAN_HOST" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]] && [[ ! "$CLEAN_HOST" =~ \.amazonaws\.com$ ]]; then
            echo "âŒ EC2_HOST í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: $CLEAN_HOST"
            exit 1
          fi
          
          # DNS ì¡°íšŒ í…ŒìŠ¤íŠ¸
          echo "DNS ì¡°íšŒ í…ŒìŠ¤íŠ¸..."
          nslookup "$CLEAN_HOST" || echo "âš ï¸ DNS ì¡°íšŒ ì‹¤íŒ¨ (ì •ìƒì¼ ìˆ˜ ìˆìŒ)"
          
          # ì •ë¦¬ëœ ê°’ì„ íŒŒì¼ë¡œ ì €ì¥ (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©)
          echo "$CLEAN_HOST" > /tmp/ec2_host
          echo "$CLEAN_USER" > /tmp/ec2_user
          
          echo "âœ… ê²€ì¦ ì™„ë£Œ"

      - name: Setup SSH
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          # ì •ë¦¬ëœ ê°’ ë¡œë“œ
          EC2_HOST=$(cat /tmp/ec2_host)
          
          mkdir -p ~/.ssh
          echo "$EC2_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          echo "SSH í‚¤ ìŠ¤ìº”: $EC2_HOST"
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts
          
          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "SSH ì—°ê²° í…ŒìŠ¤íŠ¸..."
          EC2_USER=$(cat /tmp/ec2_user)
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            "${EC2_USER}@${EC2_HOST}" "echo 'âœ… SSH ì—°ê²° ì„±ê³µ!'" || {
              echo "âŒ SSH ì—°ê²° ì‹¤íŒ¨"
              exit 1
            }

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/krafton_jungle10_team4:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache || true
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

      - name: Create .env.production
        run: |
          cat > .env.production << 'EOF'
          APP_NAME="FastAPI RAG Backend"
          APP_VERSION="1.0.0"
          DEBUG=false
          LOG_LEVEL=info
          HOST=0.0.0.0
          PORT=8001
          WORKERS=4
          CHROMA_HOST=chromadb
          CHROMA_PORT=8000
          CHROMA_COLLECTION_NAME=documents
          EMBEDDING_MODEL=intfloat/multilingual-e5-large
          EMBEDDING_DEVICE=cpu
          BATCH_SIZE=32
          MAX_FILE_SIZE=10485760
          ALLOWED_EXTENSIONS=["pdf","txt","docx"]
          CHUNK_SIZE=512
          CHUNK_OVERLAP=128
          DEFAULT_TOP_K=5
          MAX_TOP_K=50
          UPLOAD_TEMP_DIR=./data/uploads
          ENABLE_ASYNC_PROCESSING=true
          EOF

      - name: Deploy to EC2
        run: |
          # ì •ë¦¬ëœ ê°’ ë¡œë“œ
          EC2_HOST=$(cat /tmp/ec2_host)
          EC2_USER=$(cat /tmp/ec2_user)
          
          echo "ë°°í¬ ëŒ€ìƒ: ${EC2_USER}@${EC2_HOST}"
          
          # ë””ë ‰í† ë¦¬ ìƒì„±
          ssh -o StrictHostKeyChecking=no "${EC2_USER}@${EC2_HOST}" \
            'mkdir -p ~/Backend/data/{uploads,chroma_data,huggingface_cache}'
          
          # íŒŒì¼ ì „ì†¡
          scp -o StrictHostKeyChecking=no .env.production "${EC2_USER}@${EC2_HOST}:~/Backend/.env.local"
          scp -o StrictHostKeyChecking=no docker-compose.yml "${EC2_USER}@${EC2_HOST}:~/Backend/"
          scp -o StrictHostKeyChecking=no nginx.conf "${EC2_USER}@${EC2_HOST}:~/Backend/"
          
          # ë°°í¬ ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no "${EC2_USER}@${EC2_HOST}" bash << 'ENDSSH'
            set -e
            cd ~/Backend
            
            echo "ğŸ” ì¸í”„ë¼ í™•ì¸..."
            if ! docker-compose ps 2>/dev/null | grep -q "chromadb.*Up"; then
              echo "ğŸ“¦ ì¸í”„ë¼ ì‹œì‘..."
              docker-compose up -d chromadb nginx
              sleep 15
            fi
            
            echo "ğŸ³ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ..."
            docker-compose pull backend
            
            echo "ğŸ”¨ ë°±ì—”ë“œ ì¬ì‹œì‘..."
            docker-compose up -d --no-deps --force-recreate backend
            
            echo "â³ í—¬ìŠ¤ ì²´í¬..."
            sleep 10
            
            for i in {1..10}; do
              if curl -sf http://localhost/health > /dev/null 2>&1; then
                echo "âœ… ë°°í¬ ì„±ê³µ!"
                docker-compose ps
                exit 0
              fi
              echo "ëŒ€ê¸° ì¤‘... ($i/10)"
              sleep 10
            done
            
            echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
            docker-compose logs --tail=50 backend
            exit 1
          ENDSSH